# Online Pizza Ordering & Delivery System - Technical Plan

## Feature Description
A comprehensive online pizza ordering and delivery system with role-based access control. The system supports Admin, Manager, Staff, Cashier, and Customer roles with distinct permissions and interfaces. Customers can browse pizzas, customize orders, and track delivery status, while internal roles manage operations, inventory, and order fulfillment.

## Phase 1: Data Layer & Authentication Foundation

### Database Schema (Drizzle ORM + NeonDB)
**Files to create:**
- `src/lib/db/schema.ts` - Complete database schema
- `src/lib/db/migrations/` - Drizzle migration files
- `src/lib/db/index.ts` - Database connection and client

**Schema Components:**
- `users` table: id, email, password_hash, role, branch_id, created_at, updated_at
- `branches` table: id, name, address, phone, is_active, delivery_zones
- `pizzas` table: id, name, description, base_price, image_url, is_available, branch_id
- `toppings` table: id, name, price, is_available, category
- `pizza_toppings` table: pizza_id, topping_id (many-to-many)
- `orders` table: id, customer_id, branch_id, status, total_amount, delivery_address, pickup_time, created_at
- `order_items` table: id, order_id, pizza_id, quantity, customizations, price
- `order_item_toppings` table: order_item_id, topping_id, quantity
- `offers` table: id, name, description, discount_type, discount_value, valid_from, valid_until, is_active
- `notifications` table: id, user_id, order_id, message, is_read, created_at

**Role Enum:** ADMIN, MANAGER, STAFF, CASHIER, CUSTOMER

### Authentication System (NextAuth)
**Files to create:**
- `src/lib/auth.ts` - NextAuth configuration
- `src/app/api/auth/[...nextauth]/route.ts` - NextAuth API route
- `src/lib/auth/[...nextauth]/providers.ts` - Credentials provider setup
- `src/lib/auth/[...nextauth]/callbacks.ts` - Session and JWT callbacks
- `src/app/auth/signup/page.tsx` - User registration form
- `src/app/auth/signin/page.tsx` - Sign in form
- `src/app/auth/forgot-password/page.tsx` - Forgot password form
- `src/app/auth/reset-password/page.tsx` - Password reset form
- `src/app/api/auth/signup/route.ts` - User registration API
- `src/app/api/auth/forgot-password/route.ts` - Forgot password API
- `src/app/api/auth/reset-password/route.ts` - Reset password API

**Authentication Flow:**
1. **User Registration**: Public signup for customers with email validation
2. **Sign In**: Credentials provider with email/password
3. **Role-based session objects** with user permissions
4. **Password reset** via email tokens
5. **Server-side role validation** middleware
6. **Admin user creation** for internal roles (Admin, Manager, Staff, Cashier)

**Signup Features:**
- **Public Customer Registration**: Anyone can sign up as a CUSTOMER role
- **Email Validation**: Unique email requirement with proper validation
- **Password Security**: bcryptjs hashing with 12 salt rounds
- **Auto-login**: After successful registration, user is automatically signed in
- **Admin User Creation**: Internal roles (ADMIN, MANAGER, STAFF, CASHIER) must be created by existing admins
- **Branch Assignment**: Internal roles can be assigned to specific branches

## Phase 2A: Admin Dashboard & Management

### Admin Dashboard UI
**Files to create:**
- `src/app/admin/layout.tsx` - Admin layout with navigation
- `src/app/admin/page.tsx` - Admin dashboard overview
- `src/app/admin/users/page.tsx` - User management
- `src/app/admin/branches/page.tsx` - Branch management
- `src/app/admin/menu/page.tsx` - Pizza menu management
- `src/app/admin/offers/page.tsx` - Offers management
- `src/app/admin/analytics/page.tsx` - Sales analytics

### Admin API Routes
**Files to create:**
- `src/app/api/admin/users/route.ts` - CRUD operations for users
- `src/app/api/admin/branches/route.ts` - CRUD operations for branches
- `src/app/api/admin/menu/route.ts` - CRUD operations for pizzas/toppings
- `src/app/api/admin/offers/route.ts` - CRUD operations for offers
- `src/app/api/admin/analytics/route.ts` - Sales and delivery analytics

**Admin Permissions:**
- Create/edit/deactivate internal roles (Manager, Staff, Cashier)
- Manage branches, delivery zones, menu items, pricing
- View comprehensive analytics and reports
- Assign role permissions and branch assignments

## Phase 2B: Customer Interface & Ordering

### Customer UI Components
**Files to create:**
- `src/app/customer/layout.tsx` - Customer layout
- `src/app/customer/page.tsx` - Pizza browsing and ordering
- `src/app/customer/cart/page.tsx` - Shopping cart
- `src/app/customer/checkout/page.tsx` - Checkout process
- `src/app/customer/orders/page.tsx` - Order history and tracking
- `src/app/customer/profile/page.tsx` - Customer profile

### Customer API Routes
**Files to create:**
- `src/app/api/customer/menu/route.ts` - Get available pizzas by branch
- `src/app/api/customer/orders/route.ts` - Create and fetch orders
- `src/app/api/customer/orders/[id]/route.ts` - Order details and status
- `src/app/api/customer/cart/route.ts` - Cart management
- `src/app/api/customer/branches/route.ts` - Get available branches

**Customer Features:**
- Public signup route for self-registration
- Branch selection before ordering
- Pizza customization with toppings
- Real-time order status tracking
- Pickup or home delivery options

## Phase 2C: Internal Role Interfaces

### Manager Dashboard
**Files to create:**
- `src/app/manager/layout.tsx` - Manager layout
- `src/app/manager/page.tsx` - Daily operations overview
- `src/app/manager/orders/page.tsx` - Order management and assignment
- `src/app/manager/inventory/page.tsx` - Inventory management
- `src/app/manager/staff/page.tsx` - Staff assignment

### Staff Interface
**Files to create:**
- `src/app/staff/layout.tsx` - Staff layout
- `src/app/staff/orders/page.tsx` - Order preparation queue
- `src/app/staff/orders/[id]/page.tsx` - Order details and status updates

### Cashier Interface
**Files to create:**
- `src/app/cashier/layout.tsx` - Cashier layout
- `src/app/cashier/orders/page.tsx` - In-store order management
- `src/app/cashier/payments/page.tsx` - Payment processing

### Internal API Routes
**Files to create:**
- `src/app/api/manager/orders/route.ts` - Order assignment and management
- `src/app/api/manager/inventory/route.ts` - Inventory updates
- `src/app/api/staff/orders/[id]/status/route.ts` - Order status updates
- `src/app/api/cashier/payments/route.ts` - Payment processing

## Phase 3: File Upload & Media Management

### Cloudinary Integration
**Files to create:**
- `src/lib/cloudinary.ts` - Cloudinary configuration
- `src/app/api/upload/route.ts` - File upload API
- `src/components/ui/ImageUpload.tsx` - Reusable upload component

**Media Management:**
- Menu images with automatic optimization
- Banner images for promotions
- Avatar images for user profiles
- Cloudinary transformations for responsive images

## Phase 4: Notifications & Real-time Updates

### Notification System
**Files to create:**
- `src/lib/notifications.ts` - Notification utilities
- `src/app/api/notifications/route.ts` - Notification API
- `src/components/ui/NotificationBadge.tsx` - Notification indicator
- `src/hooks/useNotifications.ts` - Notification hook

**Notification Types:**
- Order status changes (Pending → Preparing → Ready → Out for Delivery)
- New order assignments for staff
- Payment confirmations
- Delivery updates

### Real-time Updates
**Files to create:**
- `src/lib/realtime.ts` - WebSocket or Server-Sent Events setup
- `src/hooks/useOrderStatus.ts` - Real-time order status hook

## Phase 5: PWA & Deployment Optimization

### PWA Configuration
**Files to create:**
- `src/app/manifest.ts` - PWA manifest
- `public/icons/` - App icons for different sizes
- `src/app/sw.ts` - Service worker for offline functionality

### Performance Optimization
**Files to create:**
- `src/lib/cache.ts` - Caching strategies
- `src/components/ui/LazyImage.tsx` - Optimized image loading
- `src/lib/analytics.ts` - Performance monitoring

## Key Algorithms & Business Logic

### Order Processing Flow
1. Customer selects branch and adds items to cart
2. Checkout validates inventory and calculates total
3. Order creation triggers notifications to relevant staff
4. Manager assigns orders to staff/drivers
5. Status updates cascade through notification system
6. Delivery tracking updates customer interface

### Role-Based Access Control
1. Server-side middleware validates user role for each route
2. UI components conditionally render based on role permissions
3. API routes enforce role-specific data access
4. Session objects contain role and branch information

### Inventory Management
1. Real-time inventory tracking during order processing
2. Low stock alerts for managers
3. Automatic item availability updates
4. Branch-specific inventory management

### Delivery Zone Management
1. Address validation against delivery zones
2. Branch assignment based on delivery zones
3. Delivery fee calculation based on distance
4. Driver assignment optimization

## Security Considerations
- Server-side role validation on all protected routes
- Input validation and sanitization for all forms
- Secure password reset flow with expiring tokens
- CSRF protection for all state-changing operations
- Rate limiting on authentication endpoints
- Secure file upload validation and processing
